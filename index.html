<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>AsomaRapi - Sistema de Despachos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #fffdf2; color: #4a3c00; margin: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        h2, h3 { text-align: center; color: #d4a017; }
        .seccion { background: #fef9e7; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ffeeba; }
        .grid-datos { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .producto { border-bottom: 1px solid #eee; padding: 10px 0; display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; align-items: center; gap: 10px; }
        input, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .btn { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-pedido { background-color: #ffcc00; color: #4a3c00; }
        .btn-excel { background-color: #1d6f42; color: white; width: 100%; margin-top: 10px; }
        
        /* Estilos Ventana de Liquidaci贸n (Modal) */
        #modal-liquidacion { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; }
        .modal-content { background: white; width: 90%; max-width: 500px; margin: 50px auto; padding: 20px; border-radius: 10px; }
        .resumen-tabla { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .resumen-tabla td { padding: 8px; border-bottom: 1px solid #eee; }
        .total-resalte { font-size: 1.2em; color: #d4a017; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2> AsomaRapi - Gesti贸n de Pedidos</h2>

    <div class="seccion">
        <h3> Datos del Cliente</h3>
        <div class="grid-datos">
            <input type="text" id="c-nombre" placeholder="Nombre completo">
            <input type="text" id="c-celular" placeholder="Celular">
            <input type="text" id="c-direccion" placeholder="Direcci贸n">
            <input type="text" id="c-ciudad" placeholder="Ciudad">
            <input type="email" id="c-correo" placeholder="Correo electr贸nico">
            <input type="number" id="valor-domicilio" placeholder="Valor Domicilio (Ej: 5000)" value="5000">
        </div>
        <textarea id="c-obs" placeholder="Observaciones (Eje: Apt 201, dejar en porter铆a...)" style="margin-top:10px; height: 60px;"></textarea>
    </div>

    <div class="seccion">
        <h3> Cat谩logo de Productos</h3>
        <div id="catalogo"></div>
    </div>

    <button class="btn btn-excel" onclick="exportarExcel()"> Descargar Informe de Ventas para Excel</button>
</div>

<div id="modal-liquidacion">
    <div class="modal-content">
        <h3> Verificaci贸n de Pedido</h3>
        <div id="detalle-liquidacion"></div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn" style="background:#ccc; flex:1" onclick="cerrarModal()">Corregir</button>
            <button class="btn" style="background:#25d366; color:white; flex:1" onclick="confirmarYEnviar()">Confirmar y enviar WhatsApp</button>
        </div>
    </div>
</div>

<script>
    const CELULAR_EMPRESA = "573015832244";
    let productos = [
        { id: 1, nombre: "Miel Multiforal 500g", precio: 25000, stock: 20 },
        { id: 2, nombre: "Polen Granulado 250g", precio: 18000, stock: 10 },
        { id: 3, nombre: "Prop贸leo Extracto", precio: 15000, stock: 15 }
    ];
    let historialVentas = [];
    let pedidoTemporal = null;

    function cargarCatalogo() {
        const div = document.getElementById('catalogo');
        div.innerHTML = "";
        productos.forEach((p, i) => {
            div.innerHTML += `
                <div class="producto">
                    <div><strong>${p.nombre}</strong><br><small>Stock: ${p.stock}</small></div>
                    <input type="number" id="p-${i}" value="${p.precio}" title="Precio Unitario">
                    <input type="number" id="q-${i}" value="1" min="1" max="${p.stock}" title="Cantidad">
                    <button class="btn btn-pedido" onclick="preLiquidar(${i})">Liquidar</button>
                </div>`;
        });
    }

    function preLiquidar(index) {
        const p = productos[index];
        const cant = parseInt(document.getElementById(`q-${index}`).value);
        const precioU = parseInt(document.getElementById(`p-${index}`).value);
        const domi = parseInt(document.getElementById('valor-domicilio').value) || 0;
        
        // Captura datos cliente
        const cliente = {
            nombre: document.getElementById('c-nombre').value,
            cel: document.getElementById('c-celular').value,
            dir: document.getElementById('c-direccion').value,
            ciu: document.getElementById('c-ciudad').value,
            mail: document.getElementById('c-correo').value,
            obs: document.getElementById('c-obs').value
        };

        if(!cliente.nombre || !cliente.cel || !cliente.dir) {
            return alert("Socio, por favor llena los datos b谩sicos del cliente (Nombre, Celular y Direcci贸n).");
        }

        const subtotal = precioU * cant;
        const total = subtotal + domi;

        pedidoTemporal = { ...cliente, producto: p.nombre, cant, precioU, domi, total, index };

        // Mostrar Modal
        const detalle = document.getElementById('detalle-liquidacion');
        detalle.innerHTML = `
            <table class="resumen-tabla">
                <tr><td><strong>Cliente:</strong></td><td>${cliente.nombre}</td></tr>
                <tr><td><strong>Ciudad/Dir:</strong></td><td>${cliente.ciu} - ${cliente.dir}</td></tr>
                <tr><td><strong>Producto:</strong></td><td>${p.nombre} (x${cant})</td></tr>
                <tr><td><strong>Subtotal:</strong></td><td>$${subtotal.toLocaleString()}</td></tr>
                <tr><td><strong>Domicilio:</strong></td><td>$${domi.toLocaleString()}</td></tr>
                <tr class="total-resalte"><td>TOTAL:</td><td>$${total.toLocaleString()}</td></tr>
            </table>
            <p><small><strong>Nota:</strong> ${cliente.obs || 'Sin observaciones'}</small></p>
        `;
        document.getElementById('modal-liquidacion').style.display = 'block';
    }

    function cerrarModal() {
        document.getElementById('modal-liquidacion').style.display = 'none';
    }

    function confirmarYEnviar() {
        // Restar stock
        productos[pedidoTemporal.index].stock -= pedidoTemporal.cant;
        
        // Guardar para Excel
        historialVentas.push({
            Fecha: new Date().toLocaleString(),
            Cliente: pedidoTemporal.nombre,
            Celular: pedidoTemporal.cel,
            Ciudad: pedidoTemporal.ciu,
            Direccion: pedidoTemporal.dir,
            Correo: pedidoTemporal.mail,
            Producto: pedidoTemporal.producto,
            Cant: pedidoTemporal.cant,
            Total: pedidoTemporal.total,
            Observaciones: pedidoTemporal.obs
        });

        const msg = `*PEDIDO CONFIRMADO ASOMARAPI*%0A%0A` +
                    ` *Cliente:* ${pedidoTemporal.nombre}%0A` +
                    ` *Cel:* ${pedidoTemporal.cel}%0A` +
                    ` *Dir:* ${pedidoTemporal.dir} (${pedidoTemporal.ciu})%0A` +
                    ` *Producto:* ${pedidoTemporal.producto} x${pedidoTemporal.cant}%0A` +
                    ` *Domicilio:* $${pedidoTemporal.domi}%0A` +
                    ` *TOTAL:* $${pedidoTemporal.total}%0A` +
                    ` *Obs:* ${pedidoTemporal.obs}`;

        window.open(`https://wa.me/${CELULAR_EMPRESA}?text=${msg}`, '_blank');
        cerrarModal();
        cargarCatalogo();
    }

    function exportarExcel() {
        if(historialVentas.length === 0) return alert("No hay ventas para exportar.");
        const ws = XLSX.utils.json_to_sheet(historialVentas);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ventas");
        XLSX.writeFile(wb, "Ventas_AsomaRapi.xlsx");
    }

    cargarCatalogo();
</script>

</body>
</html>
