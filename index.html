<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>AsomaRapi - Carrito de Compras</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #fffdf2; color: #4a3c00; margin: 20px; }
        .container { max-width: 850px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        h2, h3 { text-align: center; color: #d4a017; }
        .seccion { background: #fef9e7; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ffeeba; }
        .grid-datos { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .producto { border-bottom: 1px solid #eee; padding: 10px 0; display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; align-items: center; gap: 10px; }
        input, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .btn { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-add { background-color: #ffcc00; color: #4a3c00; }
        .btn-liquidar { background-color: #d4a017; color: white; width: 100%; font-size: 1.1em; margin-top: 10px; }
        .carrito-box { background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .ley-datos { font-size: 0.7em; color: #777; margin-top: 20px; text-align: justify; line-height: 1.2; }
        
        #modal-liquidacion { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal-content { background: white; width: 95%; max-width: 500px; margin: 20px auto; padding: 20px; border-radius: 10px; max-height: 90vh; overflow-y: auto; }
        .resumen-tabla { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.9em; }
        .resumen-tabla td { padding: 5px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="container">
    <h2>游냏 AsomaRapi - Pedido #<span id="num-consecutivo">1001</span></h2>

    <div class="seccion">
        <h3>游늸 Datos del Cliente</h3>
        <form id="form-cliente">
            <div class="grid-datos">
                <input type="text" id="c-nombre" placeholder="Nombre completo" required>
                <input type="text" id="c-celular" placeholder="Celular" required>
                <input type="text" id="c-direccion" placeholder="Direcci칩n de entrega" required>
                <input type="text" id="c-ciudad" placeholder="Ciudad" required>
                <input type="email" id="c-correo" placeholder="Correo electr칩nico (ej@mail.com)" required>
                <input type="number" id="valor-domicilio" placeholder="Valor Domicilio" value="5000">
            </div>
            <textarea id="c-obs" placeholder="Observaciones de entrega..." style="margin-top:10px; height: 50px;"></textarea>
        </form>
    </div>

    <div class="seccion">
        <h3>游꼺 Cat치logo</h3>
        <div id="catalogo"></div>
    </div>

    <div class="seccion">
        <h3>游 Carrito de Compras</h3>
        <div id="carrito-lista" class="carrito-box">El carrito est치 vac칤o.</div>
        <button class="btn btn-liquidar" onclick="abrirLiquidacion()">游 Revisar y Liquidar Pedido</button>
    </div>

    <button class="btn" style="background:#1d6f42; color:white; width:100%" onclick="exportarExcel()">游늵 Exportar Ventas a Excel</button>

    <div class="ley-datos">
        <strong>Protecci칩n de Datos Personales:</strong> En cumplimiento de la Ley 1581 de 2012, AsomaRapi informa que los datos personales recolectados ser치n utilizados 칰nicamente para la gesti칩n de su pedido, entrega de productos y contacto comercial. Usted tiene derecho a conocer, actualizar y rectificar sus datos en cualquier momento a trav칠s de nuestros canales de atenci칩n.
    </div>
</div>

<div id="modal-liquidacion">
    <div class="modal-content">
        <h3>游닍 Resumen del Pedido</h3>
        <div id="detalle-final"></div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn" style="background:#ccc; flex:1" onclick="cerrarModal()">Editar</button>
            <button class="btn" style="background:#25d366; color:white; flex:1" onclick="finalizarVenta()">Enviar a WhatsApp</button>
        </div>
    </div>
</div>

<script>
    const CELULAR_EMPRESA = "573015832244";
    let consecutivo = 1001;
    let productos = [
        { id: 1, nombre: "Miel Multiforal 500g", precio: 25000, stock: 20 },
        { id: 2, nombre: "Polen Granulado 250g", precio: 18000, stock: 10 },
        { id: 3, nombre: "Prop칩leo Extracto", precio: 15000, stock: 15 }
    ];
    let carrito = [];
    let historialVentas = [];

    function cargarCatalogo() {
        const div = document.getElementById('catalogo');
        div.innerHTML = "";
        productos.forEach((p, i) => {
            div.innerHTML += `
                <div class="producto">
                    <div><strong>${p.nombre}</strong><br><small>Stock: ${p.stock}</small></div>
                    <input type="number" id="p-${i}" value="${p.precio}">
                    <input type="number" id="q-${i}" value="1" min="1" max="${p.stock}">
                    <button class="btn btn-add" onclick="agregarAlCarrito(${i})">A침adir</button>
                </div>`;
        });
    }

    function agregarAlCarrito(index) {
        const p = productos[index];
        const cant = parseInt(document.getElementById(`q-${index}`).value);
        const precioU = parseInt(document.getElementById(`p-${index}`).value);

        if(cant > p.stock) return alert("No hay suficiente stock.");

        const itemExistente = carrito.find(item => item.id === p.id);
        if(itemExistente) {
            itemExistente.cant += cant;
        } else {
            carrito.push({ id: p.id, nombre: p.nombre, cant, precioU });
        }
        
        actualizarCarritoVisual();
    }

    function actualizarCarritoVisual() {
        const box = document.getElementById('carrito-lista');
        if(carrito.length === 0) {
            box.innerHTML = "El carrito est치 vac칤o.";
            return;
        }
        box.innerHTML = carrito.map((item, idx) => `
            <div style="display:flex; justify-content:space-between; font-size:0.9em; margin-bottom:5px;">
                <span>${item.nombre} (x${item.cant})</span>
                <span>$${(item.cant * item.precioU).toLocaleString()} 
                <button onclick="eliminarDelCarrito(${idx})" style="color:red; border:none; background:none; cursor:pointer;">[x]</button></span>
            </div>
        `).join('');
    }

    function eliminarDelCarrito(idx) {
        carrito.splice(idx, 1);
        actualizarCarritoVisual();
    }

    function abrirLiquidacion() {
        const form = document.getElementById('form-cliente');
        if(!form.checkValidity()) return alert("Socio, el correo debe ser v치lido y los campos obligatorios llenos.");
        if(carrito.length === 0) return alert("El carrito est치 vac칤o.");

        let subtotal = 0;
        let listaHtml = "";
        carrito.forEach(item => {
            subtotal += (item.precioU * item.cant);
            listaHtml += `<tr><td>${item.nombre} x${item.cant}</td><td align="right">$${(item.precioU * item.cant).toLocaleString()}</td></tr>`;
        });

        const domi = parseInt(document.getElementById('valor-domicilio').value) || 0;
        const total = subtotal + domi;

        const detalle = document.getElementById('detalle-final');
        detalle.innerHTML = `
            <p><strong>Pedido #ASO-${consecutivo}</strong></p>
            <table class="resumen-tabla">${listaHtml}
                <tr><td>Domicilio</td><td align="right">$${domi.toLocaleString()}</td></tr>
                <tr style="font-weight:bold; font-size:1.1em; color:#d4a017;"><td>TOTAL</td><td align="right">$${total.toLocaleString()}</td></tr>
            </table>
            <p><small><strong>Enviar a:</strong> ${document.getElementById('c-nombre').value}<br>
            ${document.getElementById('c-direccion').value} - ${document.getElementById('c-ciudad').value}</small></p>
        `;
        document.getElementById('modal-liquidacion').style.display = 'block';
    }

    function cerrarModal() { document.getElementById('modal-liquidacion').style.display = 'none'; }

    function finalizarVenta() {
        const nombre = document.getElementById('c-nombre').value;
        const domi = parseInt(document.getElementById('valor-domicilio').value) || 0;
        let subtotal = 0;
        let textoProductos = "";

        carrito.forEach(item => {
            subtotal += (item.precioU * item.cant);
            textoProductos += `%0A- ${item.nombre} x${item.cant} ($${(item.precioU * item.cant).toLocaleString()})`;
            // Descontar stock real
            const pReal = productos.find(pr => pr.id === item.id);
            if(pReal) pReal.stock -= item.cant;
        });

        const total = subtotal + domi;

        // Registro para Excel
        historialVentas.push({
            Pedido: `ASO-${consecutivo}`,
            Fecha: new Date().toLocaleString(),
            Cliente: nombre,
            Celular: document.getElementById('c-celular').value,
            Correo: document.getElementById('c-correo').value,
            Total: total
        });

        const msg = `*ASOMARAPI - PEDIDO #ASO-${consecutivo}*%0A%0A` +
                    `游녻 *Cliente:* ${nombre}%0A` +
                    `游늸 *Dir:* ${document.getElementById('c-direccion').value}%0A` +
                    `游냏 *Productos:* ${textoProductos}%0A%0A` +
                    `游띳 *Domicilio:* $${domi.toLocaleString()}%0A` +
                    `游눯 *TOTAL A PAGAR:* $${total.toLocaleString()}%0A%0A` +
                    `游닇 *Obs:* ${document.getElementById('c-obs').value}`;

        window.open(`https://wa.me/${CELULAR_EMPRESA}?text=${msg}`, '_blank');
        
        consecutivo++;
        document.getElementById('num-consecutivo').innerText = consecutivo;
        carrito = [];
        actualizarCarritoVisual();
        cerrarModal();
        cargarCatalogo();
    }

    function exportarExcel() {
        if(historialVentas.length === 0) return alert("No hay ventas registradas.");
        const ws = XLSX.utils.json_to_sheet(historialVentas);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ventas");
        XLSX.writeFile(wb, `Ventas_AsomaRapi_Hasta_#${consecutivo-1}.xlsx`);
    }

    cargarCatalogo();
</script>
</body>
</html>
