<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>AsomaRapi - Gesti√≥n Ap√≠cola</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #fffdf2; color: #4a3c00; margin: 20px; }
        .container { max-width: 700px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #d4a017; margin-bottom: 5px; }
        .config-sec { background: #fef9e7; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px dashed #d4a017; }
        .producto { border-bottom: 1px solid #f0f0f0; padding: 15px 0; display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; align-items: center; gap: 10px; }
        input[type="number"], input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-pedido { background-color: #ffcc00; color: #4a3c00; }
        .btn-edit { background-color: #007bff; color: white; }
        .btn-excel { background-color: #1d6f42; color: white; width: 100%; margin-top: 10px; }
        .btn-backup { background-color: #6c757d; color: white; width: 100%; margin-top: 5px; }
        .stock-tag { font-size: 0.75em; display: block; }
        .agotado { color: #cc0000; }
    </style>
</head>
<body>

<div class="container">
    <h2>üêù AsomaRapi</h2>
    <p style="text-align:center; font-size: 0.8em;">Sector Ap√≠cola - Pedidos e Inventario</p>
    
    <div class="config-sec">
        <label>üõµ <b>Valor Domicilio (COP):</b></label>
        <input type="number" id="valor-domicilio" value="5000" onchange="actualizarInterfaz()">
    </div>

    <div id="catalogo">
        </div>

    <hr>
    <button class="btn btn-excel" onclick="exportarExcel()">üìä Descargar Informe de Ventas (Excel)</button>
    <button class="btn btn-backup" onclick="hacerBackup()">üíæ Crear Backup de Inventario (JSON)</button>
    
    <a href="https://wa.me/573015832244?text=Hola,%20necesito%20hablar%20con%20un%20asesor" style="display:block; text-align:center; margin-top:15px; color:#25d366; text-decoration:none; font-weight:bold;">
        üì≤ Hablar con un Asesor
    </a>
</div>

<script>
    const CELULAR_EMPRESA = "573015832244";
    
    // Base de datos local (puedes editar los precios y stock aqu√≠)
    let productos = [
        { id: 1, nombre: "Miel Multiforal 500g", precio: 25000, stock: 20 },
        { id: 2, nombre: "Polen Granulado 250g", precio: 18000, stock: 0 },
        { id: 3, nombre: "Prop√≥leo Extracto", precio: 15000, stock: 15 }
    ];

    let historialVentas = [];

    function cargarCatalogo() {
        const catalogoDiv = document.getElementById('catalogo');
        catalogoDiv.innerHTML = "";
        
        productos.forEach((p, index) => {
            const sinStock = p.stock <= 0;
            const div = document.createElement('div');
            div.className = 'producto';
            
            div.innerHTML = `
                <div>
                    <strong>${p.nombre}</strong>
                    <span class="stock-tag ${sinStock ? 'agotado' : ''}">
                        ${sinStock ? 'SIN STOCK' : 'Stock: ' + p.stock}
                    </span>
                </div>
                <div>
                    <input type="number" id="precio-${index}" value="${p.precio}" onchange="actualizarPrecio(${index}, this.value)">
                </div>
                <div>
                    <input type="number" id="cant-${index}" value="1" min="1" max="${p.stock}" ${sinStock ? 'disabled' : ''}>
                </div>
                <div>
                    <button class="btn btn-pedido" ${sinStock ? 'disabled' : ''} onclick="pedir(${index})">Pedir</button>
                </div>
            `;
            catalogoDiv.appendChild(div);
        });
    }

    function actualizarPrecio(index, nuevoPrecio) {
        productos[index].precio = parseInt(nuevoPrecio);
        console.log(`Precio de ${productos[index].nombre} actualizado a ${nuevoPrecio}`);
    }

    function pedir(index) {
        const p = productos[index];
        const cant = parseInt(document.getElementById(`cant-${index}`).value);
        const domicilio = parseInt(document.getElementById('valor-domicilio').value);
        const total = (p.precio * cant) + domicilio;

        // Registrar Venta
        historialVentas.push({
            Fecha: new Date().toLocaleString(),
            Producto: p.nombre,
            Cantidad: cant,
            Precio_Unit: p.precio,
            Domicilio: domicilio,
            Total: total
        });

        // Restar Stock
        productos[index].stock -= cant;

        // WhatsApp
        const mensaje = `*NUEVO PEDIDO ASOMARAPI*%0A%0A` +
                        `üçØ *Producto:* ${p.nombre}%0A` +
                        `üî¢ *Cantidad:* ${cant}%0A` +
                        `üí∞ *Subtotal:* $${(p.precio * cant)}%0A` +
                        `üõµ *Domicilio:* $${domicilio}%0A` +
                        `‚úÖ *TOTAL A PAGAR:* $${total}`;
        
        window.open(`https://wa.me/${CELULAR_EMPRESA}?text=${mensaje}`, '_blank');
        cargarCatalogo(); // Refrescar stock visualmente
    }

    function exportarExcel() {
        if(historialVentas.length === 0) return alert("No hay ventas registradas para el informe.");
        const worksheet = XLSX.utils.json_to_sheet(historialVentas);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Ventas");
        XLSX.writeFile(workbook, "Informe_Ventas_AsomaRapi.xlsx");
    }

    function hacerBackup() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(productos));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "backup_asomarapi_inventario.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function actualizarInterfaz() {
        console.log("Configuraci√≥n actualizada");
    }

    cargarCatalogo();
</script>

</body>
</html>
