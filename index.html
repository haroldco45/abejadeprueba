<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>AsomaRapi V5 - Correcci√≥n WhatsApp</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #fffdf2; color: #4a3c00; margin: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        h2, h3 { text-align: center; color: #d4a017; }
        .seccion { background: #fef9e7; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ffeeba; }
        .grid-datos { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .producto { border-bottom: 1px solid #eee; padding: 10px 0; display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; align-items: center; gap: 10px; }
        input, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .btn { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-add { background-color: #ffcc00; color: #4a3c00; }
        .btn-liquidar { background-color: #d4a017; color: white; width: 100%; font-size: 1.1em; margin-top: 10px; }
        .ley-datos { font-size: 0.7em; color: #777; margin-top: 20px; text-align: justify; line-height: 1.2; }
        #modal-liquidacion { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal-content { background: white; width: 95%; max-width: 500px; margin: 20px auto; padding: 20px; border-radius: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üêù AsomaRapi - Pedido #<span id="num-consecutivo">1001</span></h2>

    <div class="seccion">
        <h3>üìç Datos del Cliente</h3>
        <form id="form-cliente">
            <div class="grid-datos">
                <input type="text" id="c-nombre" placeholder="Nombre completo" required>
                <input type="text" id="c-celular" placeholder="Celular" required>
                <input type="text" id="c-direccion" placeholder="Direcci√≥n de entrega" required>
                <input type="text" id="c-ciudad" placeholder="Ciudad" required>
                <input type="email" id="c-correo" placeholder="Correo electr√≥nico" required>
                <input type="number" id="valor-domicilio" placeholder="Valor Domicilio" value="5000">
            </div>
            <textarea id="c-obs" placeholder="Observaciones de entrega..." style="margin-top:10px; height: 50px;"></textarea>
        </form>
    </div>

    <div class="seccion">
        <h3>üçØ Cat√°logo</h3>
        <div id="catalogo"></div>
    </div>

    <div class="seccion">
        <h3>üõí Carrito</h3>
        <div id="carrito-lista" style="background:white; padding:10px; border-radius:5px; border:1px solid #ddd;">Vacio</div>
        <button class="btn btn-liquidar" onclick="abrirLiquidacion()">üßæ Revisar y Liquidar Pedido</button>
    </div>

    <div class="ley-datos">
        <strong>Protecci√≥n de Datos:</strong> Ley 1581 de 2012. Sus datos se usar√°n solo para este pedido y contacto comercial.
    </div>
</div>

<div id="modal-liquidacion">
    <div class="modal-content">
        <h3>üì¶ Confirmar Pedido</h3>
        <div id="detalle-final"></div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn" style="background:#ccc; flex:1" onclick="cerrarModal()">Corregir</button>
            <button class="btn" style="background:#25d366; color:white; flex:1" onclick="finalizarVenta()">Enviar WhatsApp</button>
        </div>
    </div>
</div>

<script>
    const CELULAR_EMPRESA = "573015832244";
    let consecutivo = 1001;
    let productos = [
        { id: 1, nombre: "Miel Multiforal 500g", precio: 25000, stock: 20 },
        { id: 2, nombre: "Polen Granulado 250g", precio: 18000, stock: 10 },
        { id: 3, nombre: "Prop√≥leo Extracto", precio: 15000, stock: 15 }
    ];
    let carrito = [];

    function cargarCatalogo() {
        const div = document.getElementById('catalogo');
        div.innerHTML = "";
        productos.forEach((p, i) => {
            div.innerHTML += `
                <div class="producto">
                    <div><strong>${p.nombre}</strong><br><small>Stock: ${p.stock}</small></div>
                    <input type="number" id="p-${i}" value="${p.precio}">
                    <input type="number" id="q-${i}" value="1" min="1">
                    <button class="btn btn-add" onclick="agregarAlCarrito(${i})">A√±adir</button>
                </div>`;
        });
    }

    function agregarAlCarrito(index) {
        const p = productos[index];
        const cant = parseInt(document.getElementById(`q-${index}`).value);
        const precioU = parseInt(document.getElementById(`p-${index}`).value);
        carrito.push({ nombre: p.nombre, cant, precioU });
        actualizarCarritoVisual();
    }

    function actualizarCarritoVisual() {
        const box = document.getElementById('carrito-lista');
        if(carrito.length === 0) { box.innerHTML = "Vac√≠o"; return; }
        box.innerHTML = carrito.map(item => `<div>‚Ä¢ ${item.nombre} x${item.cant} ($${(item.cant*item.precioU).toLocaleString()})</div>`).join('');
    }

    function abrirLiquidacion() {
        if(!document.getElementById('form-cliente').checkValidity()) return alert("Completa los datos del cliente correctamente.");
        if(carrito.length === 0) return alert("El carrito est√° vac√≠o.");
        
        let sub = 0;
        carrito.forEach(i => sub += (i.precioU * i.cant));
        const dom = parseInt(document.getElementById('valor-domicilio').value) || 0;
        
        document.getElementById('detalle-final').innerHTML = `
            <strong>Pedido #ASO-${consecutivo}</strong><br>
            Total Productos: $${sub.toLocaleString()}<br>
            Domicilio: $${dom.toLocaleString()}<br>
            <strong style="color:green">TOTAL: $${(sub+dom).toLocaleString()}</strong>
        `;
        document.getElementById('modal-liquidacion').style.display = 'block';
    }

    function cerrarModal() { document.getElementById('modal-liquidacion').style.display = 'none'; }

    function finalizarVenta() {
        const nombre = document.getElementById('c-nombre').value;
        const cel = document.getElementById('c-celular').value;
        const dir = document.getElementById('c-direccion').value;
        const ciu = document.getElementById('c-ciudad').value;
        const dom = parseInt(document.getElementById('valor-domicilio').value) || 0;
        const obs = document.getElementById('c-obs').value;
        
        let listaTexto = "";
        let totalP = 0;
        
        carrito.forEach(item => {
            totalP += (item.precioU * item.cant);
            listaTexto += `- ${item.nombre} x${item.cant} ($${(item.precioU * item.cant).toLocaleString()})%0A`;
        });

        const totalFinal = totalP + dom;

        // EL SECRETO EST√Å EN ESTA CADENA DE TEXTO (URL ENCODED)
        const msg = `*ASOMARAPI - PEDIDO #ASO-${consecutivo}*%0A%0A` +
                    `üë§ *Cliente:* ${nombre}%0A` +
                    `üìû *Cel:* ${cel}%0A` +
                    `üìç *Dir:* ${dir} (${ciu})%0A%0A` +
                    `üêù *PRODUCTOS:*%0A${listaTexto}%0A` +
                    `üõµ *Domicilio:* $${dom.toLocaleString()}%0A` +
                    `üí∞ *TOTAL:* $${totalFinal.toLocaleString()}%0A%0A` +
